<!DOCTYPE html>
<meta charset="utf-8">
<head>
<link rel="stylesheet" type="text/css" href="css/vicons-font.css" />
<link rel="stylesheet" type="text/css" href="css/buttons.css" />
<link href="css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="css/commonfare.css"></head>
        
<body>
    <!--Container for the network viz-->
    <svg style="width:45%; float:left; display:inline-block;" class="bigvis" width="500" height="600"></svg>
   
   <div class="filterelements" style="width:45%; text-align: center; display:inline-block">
    <div style="display:block;" class="sectiontitle">
        Interactions view
    </div>
   <div style="display:block; text-align: center;" >
    	<button onclick="loadDataFiles(d3.queue(),'monthly')" class="button button--ujarak button--border-thin button--text-thick">By month</button>
		<button onclick="loadDataFiles(d3.queue(),'cumulative')" class="button button--ujarak button--border-thin button--text-thick">Cumulative</button>       
    </div>
    
    <!--Date slider-->
    <svg id="myslider" class="myslider" style="width:100%;display:block;" height="120"></svg>
    <div style="width:45%;display:inline-block;" class="sectiontitle">
        Tag filters
    </div>
    <div class="list-group" id="list-group" style="width:45%;display:block; margin: 0 auto; text-align: center">
    </div>
    
    <div style="display:block;" class="sectiontitle">
        Network type filters
    </div>
    <div style="display:block; text-align: center;" >
    	<button onclick="nwfilter('all',this)" class="button button--ujarak button--border-thin button--text-thick">All</button>
		<button onclick="nwfilter('social',this)" class="button button--ujarak button--border-thin button--text-thick">Social</button>
		<button onclick="nwfilter('story',this)" class="button button--ujarak button--border-thin button--text-thick">Stories</button>
		<button onclick="nwfilter('transaction',this)" class="button button--ujarak button--border-thin button--text-thick">Transactions</button>             
	</div>
    
    </div>
    <!--Container for the line chart of network tags over time-->
    <svg id="tagchart" height="300" width="500" class="tagchart" style="display:inline-block;"></svg>
    
    <div id="reset_user" style="width: 100%; text-align:center">
    </div>
    <div id="userinfo" style="width: 100%; text-align:center;">
        <!--Container for a selected user's Commonshare chart over time-->
        <div style="vertical-align:top;display:inline-block; margin: 0 auto; width:400px;">
            <svg height="400" width="400" id="commonchart" class="commonchart"></svg>
        </div>
        
        <!--Container for a selected user's calendar-->
        <div style="display:inline-block; margin: 0 auto; width: 400px">
            <h5 id="yearmonth"></h5>
            <svg height="400" width="400" class="activitychart"></svg>
        </div>
    </div>
</body>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script>
//All this stuff is for the network viz
var data = {};
var drawn = {};
var xScale = d3.scaleLinear()
    .domain([0,500]).range([0,500]);
var yScale = d3.scaleLinear()
    .domain([0,600]).range([0, 600]);

//Zooming function
function zoomFunction(){
    var new_xScale = d3.event.transform.rescaleX(xScale)
    var new_yScale = d3.event.transform.rescaleY(yScale)
    g.attr("transform", d3.event.transform)
};
var zoom = d3.zoom().on("zoom", zoomFunction);
var svg = d3.select(".bigvis"), width = +svg.attr("width"), height = +svg.attr("height");
svg.call(zoom);

//These forces are tweaked to attract connected nodes to the center
var simulation = d3.forceSimulation()
    .alphaDecay(0.2)
    .force("charge", d3.forceManyBody().strength(function(d){return -300;}))
    .force("link", d3.forceLink().distance(75).iterations(10).id(function(d){return d.id;})) //Need the function here to draw links between nodes based on their ID rather than their index
    .force("x", d3.forceX().x(function(d){if(d.kcore == 0)return 100; return width/2;}).strength(function(d){if(d.kcore == 0)return 0.4; return 0.1;}))
    .force("y", d3.forceY().y(function(d){if(d.kcore == 0)return 100; return height/2;}).strength(function(d){if(d.kcore == 0)return 0.4; return 0.1;}))
    .stop();
    
var g = svg.append("g").attr("transform", "translate(250,250) scale (.35,.35)"),
    link = g.append("g").attr("stroke", "#000").attr("stroke-width", 1.5).selectAll(".link"),
    node = g.append("g").attr("stroke", "#fff").attr("stroke-width", 1.5).selectAll(".node");
svg.call(zoom.transform, d3.zoomIdentity.translate(250, 250).scale(0.35));

//Tooltip functions from http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html    
var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

var slideradded = false;
function loadDataFiles(queue,view){    
    var url = "";
    if(view == "monthly")
      url = "data/graphdata/graphmonthly/monthdata" + datafilecounter + ".json";
    else
      url = "data/graphdata/graphcumulative/cumudata" + datafilecounter + ".json";
    $.ajax({
       
        url: url,
        type:'HEAD',
        
        error: function()
        {
        queue.awaitAll(function(error,results) {
            if (error) throw error;
            else{
                for(var i = 0; i < results.length; i++){
                    data[i] = results[i];
                    drawn[i] = false;
                }
            draw(0,0,'all');
            if(slideradded == false)
                    addDateSlider();
            else{
                sliderhandle.attr("cx",0);
             d3.selectAll(".ticktext")
                        .style("fill","black")
                        .style("font-weight","normal");
            }
            }
        }); 
        //datafilecounter = 1;
        },
        success: function()
        {
        console.log("Must try and load data/data"+datafilecounter+".json!");
        queue.defer(d3.json, url);
        datafilecounter++;
        loadDataFiles(queue,view);
        }
    });
}
//Ensure all JSON files are loaded before initiating visualisation    
var q = d3.queue();

var datafilecounter = 1;
loadDataFiles(q,'monthly');


//The node that's been clicked on to maintain focus across different months
clicked_node = "";

//zoom transform from https://bl.ocks.org/mbostock/b783fbb2e673561d214e09c7fb5cedee allows clicked node to be zoomed in on
function transform() {
  translatex = d3.select("#n" + clicked_node).attr("cx");
  translatey = d3.select("#n" + clicked_node).attr("cy");
  console.log("transforming to " + translatex + " , " + translatey);
  return d3.zoomIdentity
      .translate(width / 2, height / 2)
      .scale(4)
      .translate(-translatex, -translatey);
}

var taglistindex;
function draw(indexstart,tag,filtertype){
   nodetypes = {};

    //https://stackoverflow.com/questions/11347779/jquery-exclude-children-from-text
    $.fn.ignore = function(sel){
      return this.clone().find(sel||">*").remove().end();
    };
    
    graph = data[indexstart];
    selected_node = "";
    //These commented lines filter nodes and links by tag so they aren't rendered at all. May be more applicable when scaling up
    // node = node.data(graph.nodes.filter(function(d){return tag == "all" || d.tags.includes(tag);}), function(d) {return d.id;});
    // link = link.data(graph.links.filter(function(d){return tag == "all" || d.edgetags.includes(tag);}), function(d) { return d.source.id + "-" + d.target.id;});
    node = node.data(graph.nodes,function(d) {return d.id;});
    link = link.data(graph.links,function(d) { return d.source.id + "-" + d.target.id;});
    tagcounts = graph.tagcount;
    
    
    var listContainer = $('.list-group');
    if(taglistindex != indexstart){
        taglistindex = indexstart;
        listContainer.empty();
        for(var i = 0; i < tagcounts.length; i++){
            var tagname = tagcounts[i][0];
            var tagnum = tagcounts[i][1];
            listContainer.append('<a href="#" class="list-group-item">' + tagname + '<span class="badge">'+ tagnum + '</span></a>');
        }
        $('a').click( function(e) {e.preventDefault(); 
            var content = $(this).ignore("span").text(); // or var clickedBtnID = this.id
            console.log("text is " + content);
            draw(sliderpos,content,"tag");
            return false; });
    }

    node.exit().transition()
    .attr("r", 0)
    .remove();

    node = node.enter().append("circle")
    .call(d3.drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended))
    .merge(node)
    .each(function(d){nodetypes[d.id] = d.type;})
    
    .attr("id", function(d) { return "n"+d.id; }) //Now each datum can be accessed as a DOM element
    .attr("meta", function(d) { return "n" + JSON.stringify(d.type);})    
    .attr("r", function(d) { return (d.kcore*2) + 5;})
    .attr("fill", function(d) {
        if(d.id==clicked_node)return d3.color("orange");
        if(d.type == "commoner") return d3.color("steelblue");
        if(d.type == "listing") return d3.color("purple");
        if(d.type=="tag") return d3.color("lightgreen");
        return d3.color("red"); }) //Coloured based on their type
    .style("opacity", function(d) { //Make nodes and links transparent if they aren't linked to tags
        if(filtertype == "tag"){
            if(tag == "all" || (d.type == "tag" && d.name == tag) || d.tags.includes(tag))
                return 1; 
            return 0.15;
        }
        else if(filtertype == "network"){
            if(tag == "all" || d.nodemeta.includes(tag))
                return 1;
            return 0.15;
        }
        else{
            return 1;
        }
    }) 
    .on("click", function(od) {
        //Reset previously clicked node's colour
        if(clicked_node != "")
            d3.select("#n"+clicked_node).attr("fill", function(d) {if(d.type == "commoner") return d3.color("steelblue"); if(d.type == "listing") return d3.color("purple"); if(d.type=="tag") return d3.color("lightgreen");  return d3.color("red"); }) //Coloured based on their type
        window.open('https://djr53.host.cs.st-andrews.ac.uk/commonfare/web/cshareall.html?userid=' + od.id, '_blank');

    })
    //Node and link highlighting
    .on("mouseover", function(d) {
        selected_node = d.id;
        d3.select(this).attr("fill",d3.color("orange"));
        sourcelinks = link.filter(function(d){return d.source.id == selected_node || d.target.id == selected_node;});
        //Style links of hovered node
         //Style links of hovered node
        sourcelinks.each(function(d){
            d3.select(this).attr("oldstrokeval",d3.select(this).style("stroke-width"));
            d3.select(this).attr("oldcolourval",d3.select(this).style("stroke"));
            d3.select(this).style("stroke",'green');

        });
        //Add the tooltips, formatted based on whether they represent a user or story
        div.transition()        
            .duration(200)      
            .style("opacity", .9); 
        if(d.type == "commoner" || d.type=="tag"){
            div.html(d.name)  
               .style("left", (d3.event.pageX) + "px")     
               .style("top", (d3.event.pageY - 28) + "px")
               .style("background",function(){if(d.type=="commoner")return "lightsteelblue";return "lightgreen";});    
        }
        else{
            div.html(d.title)  
               .style("left", (d3.event.pageX) + "px")     
               .style("top", (d3.event.pageY - 28) + "px")
               .style("background", "pink");    
        }
    })                  
    .on("mouseout", function(d) {
        //Set the colour of links back to black, and the thickness to its original value
               d3.select(this).attr("fill", function(d) {if(d.type == "commoner") return d3.color("steelblue"); if(d.type == "listing") return d3.color("purple"); if(d.type=="tag") return d3.color("lightgreen"); return d3.color("red"); });
        sourcelinks.each(function(d){d3.select(this).style("stroke",d3.select(this).attr("oldcolourval"));});
        sourcelinks.each(function(d){d3.select(this).style("stroke-width",d3.select(this).attr("oldstrokeval"));});
        div.transition()        
            .duration(500)      
            .style("opacity", 0);   
    });

   //Arrowheads that show the direction of the interaction. Have to be drawn manually
    svg.selectAll("defs").remove();
    svg.append("defs").selectAll("marker")
    .data(graph.links)
    .enter().append("marker")
    .each(function(d){if('create_story' in d || 'create_listing' in d)d.size = 2;else d.size=1;})
    .attr("id", function(d) { return "mend" + d.source.id + "-" + d.target.id; })
    .attr("viewBox",function(d){if(d.size==2)return "0 -10 20 20";return "0 -5 10 10"})
    .attr("refX", function(d){
        if(d.target.id == null)return 10; 
        radius = d3.select("#n"+d.target.id).attr("r");
        return (d.size*10) + parseInt(radius);})
    .attr("markerUnits","userSpaceOnUse")
    .attr("markerWidth",function(d){return d.size*10;})
    .attr("markerHeight", function(d){return d.size*10;})
    .attr("orient", "auto")
    .append("path")
    .attr("d", function(d){if(d.size == 2)return "M0,-10L20,0L0,10"; return "M0,-5L10,0L0,5"})
    .style("fill",function(d){
            if('edgemeta' in d && d.edgemeta.includes('story'))
                return 'red';
            if('edgemeta' in d && d.edgemeta.includes('social'))
                return 'orange';
            if('edgemeta' in d && d.edgemeta.includes('listing'))
                return 'purple';
            if('edgemeta' in d && d.edgemeta.includes('transaction'))    
                return 'darkblue';
            return 'black';
        });
     
    svg.append("defs").selectAll("marker")
    .data(graph.links)
    .enter().append("marker")
    .each(function(d){if('create_story' in d || 'create_listing' in d)d.size = 2;else d.size=1;})    
    .attr("id", function(d) { return "mstart" + d.source.id + "-" + d.target.id; })
    .attr("viewBox",function(d){if(d.size==2)return "-20 -10 20 20";return "-10 -5 10 10"})
    .attr("refX", function(d){
        if(d.source.id == null)return 10; 
        radius = d3.select("#n"+d.source.id).attr("r");
        return -(d.size*10) - parseInt(radius);})
    .attr("markerUnits","userSpaceOnUse")
    .attr("markerWidth",function(d){return d.size*10;})
    .attr("markerHeight", function(d){return d.size*10;})
    .attr("orient", "auto")
    .append("path")
    .attr("d", function(d){if(d.size == 2)return "M0,-10L-20,0L0,10";return "M0,-5L-10,0L0,5"})
    .style("fill",function(d){
            if('edgemeta' in d && d.edgemeta.includes('story'))
                return 'red';
            if('edgemeta' in d && d.edgemeta.includes('social'))
                return 'orange';
            if('edgemeta' in d && d.edgemeta.includes('listing'))
                return 'purple';
            if('edgemeta' in d && d.edgemeta.includes('transaction'))    
                return 'darkblue';
            return 'black';
        });
    
    //Add the links. Thickness is currently determined by the square root of the sum of the weight from either node
    link.exit()
      .remove();
    link = link.enter().append("line")
      .attr("class","line")
      .merge(link) 
      .attr("stroke-width",function(d){
        if('create_story' in d || 'create_listing' in d)
            return 4.5;
        else if('tag_story' in d || 'tag_commoner' in d || 'tag_listing' in d)
            return 0.25;
        return 2;
      })
    .attr("edgemeta", function(d){return d.id + JSON.stringify(d.edgemeta);})
    .style("stroke",function(d){
            if('edgemeta' in d && d.edgemeta.includes('story'))
                return 'red';
            if('edgemeta' in d && d.edgemeta.includes('social'))
                return 'orange';
            if('edgemeta' in d && d.edgemeta.includes('listing'))
                return 'purple';
            if('edgemeta' in d && d.edgemeta.includes('transaction'))    
                return 'darkblue';
            return 'black';
        })
     .attr("marker-end", function(d){
       if((nodetypes[d.source.id] == 'commoner' && nodetypes[d.target.id] != 'tag')){
            return "url(#mend" + d.source.id + "-" + d.target.id + ")";
            }
        return null; 
    })
    .attr("marker-start", function(d){
       if((nodetypes[d.target.id] == 'commoner' && nodetypes[d.source.id] != 'tag')){
            return "url(#mstart" + d.source.id + "-" + d.target.id + ")";
            }
        return null;
       })
    .style("opacity", function(d) {
        if(filtertype == "tag"){
            if(tag == "all" || (d.source.type == "tag" && d.source.name == tag) || (d.target.type == "tag" && d.target.name == tag))
                return 1; 
            return 0.15;
        }
        else if(filtertype == "network"){
            if(tag == "all" || (d.edgemeta != null && d.edgemeta.includes(tag)))
                return 1;
            return 0.15;
        }
        else{
        return 1;
        }        
    });

    //Updates to make on simulation 'tick'
    function ticked() {
        link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

        node
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
    }

    //Dragging functions
    function dragstarted(d) {
        d3.event.sourceEvent.stopPropagation();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
        d.x = d3.event.x;
        d.y = d3.event.y;
        ticked();
    }

    function dragended(d) {
        d.fx = null;
        d.fy = null;
    }

    d3.timeout(function(){    
        // Update and restart the simulation.
        simulation.nodes(graph.nodes);

        //Manually update the simulation so it doesn't take a long time to do its thing
        simulation.force("link").links(graph.links);
        if(drawn[indexstart] == false){
            drawn[indexstart] = true;
            simulation.alpha(1);
            for (var i = 0, n = Math.ceil(Math.log(simulation.alphaMin()) / Math.log(1 - simulation.alphaDecay())); i < n; ++i) {
                simulation.tick();
            }
            //Here we continue to draw the graph for each month until they're all done
            if((datafilecounter-1) > (indexstart+1)){
                indexstart++;
                draw(indexstart,indexstart,'all');
            }
            else{
                monthvalue = 0;
                draw(0,0,'all');
                datafilecounter = 1;
            //    plotcommonsharevals();
            }
        }
        link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

        node
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
        //If we've clicked on a node, maintain its focus while going through the different months
        if(clicked_node != "")
            svg.call(zoom.transform, transform);
    });

}

var parseMonth = d3.timeParse("%Y-%m");
var parseTime = d3.timeParse("%Y/%m/%d");
var formatMonth = d3.timeFormat("%b %y");
var formatWeek = d3.timeFormat("%d/%m/%y");
var formatToList = d3.timeFormat("%Y-%m");

var tagvalue = "all";
var networkvalue = "all";
var currentfilter = "";



//Functions for filtering based on tag/network type buttons
function nwfilter(nwname,button){
    currentfilter = "network";
    networkvalue = nwname;

    var buttons = document.getElementsByTagName("button");
    for (var i = 0; i < buttons.length; i++) {
        var currentbutton = buttons[i];
        currentbutton.style.background = '#fff';
        currentbutton.style.color = '#37474f';
    }
    draw(sliderpos,networkvalue,"network");
    button.style.color = "#fff";
	button.style.borderColor = "#37474f";
    button.style.background = "#37474f";
}

function filter(tagname,button){
    currentfilter = "tag";
    tagvalue = tagname;
    
    var buttons = document.getElementsByTagName("button");
    for (var i = 0; i < buttons.length; i++) {
        var currentbutton = buttons[i];
        currentbutton.style.background = '#fff';
        currentbutton.style.color = '#37474f';
    }
    draw(sliderpos,tagvalue,"tag");
    button.style.color = "#fff";
	button.style.borderColor = "#37474f";
    button.style.background = "#37474f";
}
var sliderpos = 0;
var sliderhandle;
    //New date slider code (adapted from https://bl.ocks.org/mbostock/6452972)
function addDateSlider(){
    slideradded = true;
    var s = document.getElementById("myslider");

    var slidesvg = d3.select(".myslider"),
        margin = {right: 50, left: 50, top: 100, bottom: 50},
        height = +slidesvg.attr("height");
    var sliderwidth = parseFloat(window.getComputedStyle(s).width)- margin.left - margin.right;
    var slidex = d3.scaleLinear()
        .domain([0, Object.keys(data).length-1])
        .range([0, sliderwidth])
        .clamp(true);
        
    var slider = slidesvg.append("g")
        .attr("class", "slider")
        .attr("transform", "translate(" + margin.left + "," + height / 2 + ")");
        

    slider.append("line")
        .attr("class", "track")
        .attr("x1", slidex.range()[0])
        .attr("x2", slidex.range()[1])
      .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
        .attr("class", "track-inset")
      .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
        .attr("class", "track-overlay");
        

    var ticks = slider.insert("g", ".track-overlay")
        .attr("class", "ticks")
        .attr("transform", "translate(0," + 18 + ")");
        
    var ticktext = ticks.selectAll(".ticktext")
        .data(slidex.ticks(Object.keys(data).length-1))
        .enter().append("g")
        .attr("class","ticktext")
        .attr("id",function(d){return "tick"+d;})
        .attr("transform",function(d,i){return "translate(" +slidex(i) + ",0)";});

        ticktext.append("text")
        .text(function(d,i) {console.log(data[d]); if(i%2 == 1)return ""; return formatWeek(parseTime(data[d].date)); })
   .attr("class","tickz")
    .attr("transform", "rotate(-65)")
    .style("text-anchor", "end");
    
      sliderhandle = slider.append("circle")
        .attr("class", "handle")
        .attr("r", 9)
        .call(d3.drag()
            .on("start",function(){console.log("BEGINNETH");})
            .on("drag", function() { 
                console.log("hello?");
                var selected_date = Math.round(slidex.invert(d3.event.x));
                if(selected_date != sliderpos){
                    sliderpos = selected_date;
                    console.log("date is " + selected_date);
                    d3.selectAll(".ticktext")
                        .style("fill","black")
                        .style("font-weight","normal");
                    d3.select("#tick"+selected_date)
                        .style("fill","orange")
                        .style("font-weight","bold");
                    if(currentfilter == "tag")
                       draw(sliderpos,tagvalue,"tag");
                    else
                       draw(sliderpos,networkvalue,"network");
                }
                sliderhandle.attr("cx", slidex(slidex.invert(d3.event.x)));}));
}
</script>
