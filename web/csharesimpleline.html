<!DOCTYPE html>
<meta charset="utf-8">
<head>
<link rel="stylesheet" type="text/css" href="css/commonfare.css">
</head>
<body>
<div style="width: 100%; text-align:center;">
    <div style="display:inline-block;width:1600px">
        <h5>Your Commonshare</h5>    
        <svg style="display:inline-block;width:1600px;"class="commonchart" width="1400" height="400"></svg>
    </div>
</div>
</body>


<script src="https://d3js.org/d3.v4.min.js"></script>

<script>
var prettyKeys = 
{"create_Story":"Stories written",
"comment_Story":"Story comments made",
"rcomment_Story":"Story comments received",
"like_Story":"Story likes left",
"rlike_Story":"Story likes received",
"create_ForumPost":"Forum posts created",
"comment_ForumPost":"Post comments made",
"rcomment_ForumPost":"Post comments received",
"like_ForumPost":"Post likes left",
"rlike_ForumPost":"Post likes received",
"transaction":"Transactions made",
"rtransaction":"Transactions made",
"friendship":"Friends made",
"rfriendship":"Friends made"
};
//All this stuff is for the network viz
var urlParams = new URLSearchParams(window.location.search);
var userid = urlParams.get('userid'); // "edit"
//Generates a random user ID between 0 and 499 (because the viz is currently working with 500 simulated users)
var data = {};
var xScale = d3.scaleLinear()
    .domain([200,1600]).range([200,1600]);
var yScale = d3.scaleLinear()
    .domain([0,400]).range([0,400]);

//Zooming function
function zoomFunction(){
    var new_xScale = d3.event.transform.rescaleX(xScale)
    var new_yScale = d3.event.transform.rescaleY(yScale)
    g.attr("transform", d3.event.transform)
};
var zoom = d3.zoom().on("zoom", zoomFunction);

//Tooltip functions from http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html    
var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

//Ensure all JSON files are loaded before initiating visualisation    
var q = d3.queue();
d3.json('data/users/'+userid+'.json',function(results){
    data = results;
  //  plotcalendars(userid,months[0]);
    plotcommonshare(userid);
});

//zoom transform from https://bl.ocks.org/mbostock/b783fbb2e673561d214e09c7fb5cedee allows clicked node to be zoomed in on
function transform() {
  translatex = d3.select("#n" + userid).attr("cx");
  translatey = d3.select("#n" + userid).attr("cy");
  console.log("transforming to " + translatex + " , " + translatey);
  return d3.zoomIdentity
      .translate(width / 2, height / 2)
      .scale(2)
      .translate(-translatex, -translatey);
}

//Temporary hack because I know the month names
var months = ['2018-06','2018-07','2018-08','2018-09','2018-10','2018-11','2018-12','2019-01','2019-02','2019-03','2019-04']

/*-------------COMMONSHARE AREA CHART---------------*/

var chart = d3.select(".commonchart"),
    margin = {top: 20, right: 20, bottom: 70, left: 250},
    chartwidth = +chart.attr("width") - margin.left - margin.right,
    chartheight = +chart.attr("height") - margin.top - margin.bottom,
    chartg = chart.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var parseTime = d3.timeParse("%d/%m/%y");
var parseMonthAxis = d3.timeFormat("%Y-%m");

var x = d3.scaleTime()
    .rangeRound([0, chartwidth]);
var y = d3.scaleLinear()
    .rangeRound([chartheight, 0]);

var line = d3.line()
    .curve(d3.curveMonotoneX)
    .x(function(d) { return x(parseTime(d.date)); })
    .y(function(d) { return y(d.total); });

var kcoreline = d3.line()
    .curve(d3.curveMonotoneX)
    .x(function(d) { return x(parseTime(d.date)); })
    .y(function(d) { return y(d.kcore); });
function plotcommonshare(user){
    var kcorelist = []
    var avg_total_object = []
    for (var month in data){
        console.log(data[month]);
        var avg_totals = data[month].avg_totals; 
        keys = Object.keys(avg_totals);        
        for (var name in avg_totals){
            if(avg_totals.hasOwnProperty(name)){
                if(!(name in avg_total_object))
                    avg_total_object[name] = [];
                avg_total_object[name].push({"id": name, "stats": data[month].stats, "date":data[month].date, "total": avg_totals[name]}); 
            }
        };
        data[month].kcore = +data[month].kcore
        kcorelist.push({"date":data[month].date,"kcore":data[month].kcore});
    }
    console.log(kcorelist);
 //console.log(avg_total_object);
  var avgdata_list = Object.keys(avg_total_object).map(function(k) { return {"id": k, "date":data[month].date, "values":avg_total_object[k] };});  
  x.domain([
  d3.min(avgdata_list,function(c) {return d3.min(c.values, function(d) {return parseTime(d.date); });}),
  d3.max(avgdata_list,function(c) { return d3.max(c.values, function(d) {return parseTime(d.date); });})
  ]);
  
  y.domain([
  d3.min(avgdata_list,function(c) {return d3.min(c.values, function(d) {return d.total; });}),
  d3.max(avgdata_list,function(c) { return d3.max(c.values, function(d) {return d.total; });})
  ]);
  
  var color = d3.scaleOrdinal() // D3 Version 4
  .domain(keys)
  .range(['#a6cee3','#1f78b4','#b2df8a','#33a02c']);
     
    var meta = chartg.selectAll('.meta')
    .data(avgdata_list)
    .enter().append("g")
    .attr("class","meta");
   
    meta.append("path")
    .attr("class","line")
    .attr("clip-path", "url(#clip)")
    .attr("id",function(d){return d.id;})
    .attr("d",function(d){return line(d.values);})
    .style("stroke", function(d) { return color(d.id); });

      
    var linepath = chartg.append("path")
    .datum(kcorelist)
    .attr("class","mypath")
    .attr("clip-path", "url(#clip)")
    .attr("d",kcoreline)
    .style("stroke","black")
    .style("stroke-width",2.5);
   
  var clip = chartg.append("clipPath")
    .attr("id", "clip");
  var clipRect = clip.append("rect")
    .attr("width", 0)
    .attr("height", 400);
  var totalLength = chartwidth;
  
  clipRect.transition()
    .duration(5000)
    .ease(d3.easeLinear)
    .attr("width", totalLength)
 
   chartg.selectAll(".dots")
    .data(avgdata_list)
    .enter().append("g")
    .attr("class", "dots")
    .selectAll("circle")
    .data(function(d) {return d.values; })
      .enter().append("circle")
      .attr("class",function(d){return "mydot" + d.id;})
      .style("fill", function(d) { return color(d.id); })
      .attr("id",function(d,i) { return "dot"+ d.id + "-" + (i);})
      .attr("r", 4)
      .attr("clip-path","url(#clip)")
      .attr("cx", function(d) {return x(parseTime(d.date)); } )
      .attr("cy", function(d) {return y(d.total); } )
       .on("mouseover", function(d) {
            var html_content = "";
            for(var meta in d.stats){
                console.log("meta is " + meta);
                if(meta == d.id){ //If this holds the interactions of this particular type
                    for(var statistic in d.stats[meta]){
                        console.log("statistic is " + statistic);
                        if(d.stats[meta][statistic].length > 0)
                            html_content += prettyKeys[statistic] + ": " + d.stats[meta][statistic].length + "<br/>";
                    }
                }
            }
            d3.select(this).attr("r",8);
            div.transition()		
                .duration(200)		
                .style("opacity", .9);		
            div	.html(html_content)	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");	
            })					
        .on("mouseout", function(d) {	
            d3.select(this).attr("r",4);
            div.transition()		
                .duration(500)		
                .style("opacity", 0);	
        });
      
  

 
  chartg.append("g")
      .attr("transform", "translate(0," + chartheight + ")")
      .attr("class","axis")
      .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%Y-%m")))
      .selectAll("text")	
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-65)");;

  chartg.append("g")
      .attr("class","axis")
      .call(d3.axisLeft(y).ticks(5))
      .append("text")
        .attr("fill", "#000")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", "0.71em")
        .attr("text-anchor", "end")
        .text("Commonshare");

  
  //Adapted from http://zeroviscosity.com/d3-js-step-by-step/step-3-adding-a-legend
  var legendRectSize = 18;
  var legendSpacing = 4;
  var opacity = 1;
  var legend = chartg.selectAll(".legend")
    .data(color.domain())
    .enter()
    .append('g')
    .attr('class','legend')
    .attr('transform', function(d,i){
        var height = legendRectSize + legendSpacing;
        var horz = -6* legendRectSize;
        var vert = i * height;
        return 'translate(' + horz + ',' + vert + ')';
    })
    .on("mouseover",function(d){d3.select(this).style('fill',color);document.body.style.cursor = "pointer";})
    .on("mouseout",function(d){d3.select(this).style('fill','black');document.body.style.cursor = "auto";})
    .on("click",function(d){legendclick(d);d3.select(this).style('opacity',opacity);});
    
    
  legend.append('rect')
  .attr('width', legendRectSize)
  .attr('height', legendRectSize)
  .style('fill',color)
  .style('stroke',color);
  
  legend.append('text')
  .attr('x', legendRectSize + legendSpacing)
  .attr('y', legendRectSize - legendSpacing)
  .text(function(d) { return d;});
  var olddate = "";
  
  function legendclick(d){
    console.log("You clicketh the legend");
    if(d3.select("#"+d).style("visibility") == "visible"){
        d3.select("#"+d).style("visibility","hidden");
        d3.selectAll(".mydot"+d).style("visibility","hidden");
        opacity = 0.5;
    }
    else{
        d3.select("#"+d).style("visibility","visible");
        d3.selectAll(".mydot"+d).style("visibility","visible");
        opacity = 1;
    }
  }
  function legendmove(){
      document.body.style.cursor = "pointer";
  }

}

/*--------------------CALENDAR VIZ-----------------------*/
/*
var rect = d3.select(".activitychart").append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g").selectAll(".day");

//Sums up the weights of all interactions on a given day
function summer(total, num) {
    return total + num[1];
}

function plotcalendars(user,mymonth){
    rect.selectAll("rect").remove();
    rect.selectAll("text").remove();
    graph = data[mymonth];
    var width = 960, height = 750, cellSize = 40;
    var day = d3.timeFormat("%w"), // day of the week
        week = d3.timeFormat("%U"), // week number of the year
        month = d3.timeFormat("%m"), // month number
        monthname = d3.timeFormat("%B"),
        year = d3.timeFormat("%Y"),
        dayofmonth = d3.timeFormat("%d"),
        myformat = d3.timeFormat("%d/%m/%y");
    
    var datum = graph.nodes[0];
    var graphyear = +year(parseTime(datum.date));
    var graphmonth = +month(parseTime(datum.date))-1;
    console.log("Graph year is " + graphyear + " and graphmonth is " + graphmonth);
    document.getElementById("yearmonth").innerHTML = monthname(parseTime(datum.date)) + " " + year(parseTime(datum.date));
    
    var graphdata = graph.nodes.filter(function(d){return user == d.id;})[0];
    if(graphdata == null){
        //Here we map the list of dates to the stats of our selected user
        var mapped = d3.timeDays(new Date(graphyear,graphmonth,0), new Date(graphyear,graphmonth+1,1)).map((val, index, arr) => {
            return {
                date: val, //The original date becomes 'date' in the returned object
                stats: {}, //And the interactions for this date in the graphdata are returned as 'stats'
                sumval: 0
            };
        });
    }
    else{
    //Here we map the list of dates to the stats of our selected user
    var mapped = d3.timeDays(new Date(graphyear,graphmonth,0), new Date(graphyear,graphmonth+1,1)).map((val, index, arr) => {
        return {
            date: val, //The original date becomes 'date' in the returned object
            stats: graphdata.stats[myformat(val)], //And the interactions for this date in the graphdata are returned as 'stats'
            sumval: myformat(val) in graphdata.stats ? graphdata.stats[myformat(val)].reduce(summer,0) : 0
        };
    });
    }
    //Set up colour range (darker green means higher value to actions)
    rect = rect.data(mapped,function(d) {return d;})
    var buckets = 7,
    greens = ['#f3a396','#f09081','#ee7e6c','#eb6b57','#e95942','#e7472e','#cf3f29'];
    colorScale = d3.scaleQuantile()
                .domain([0, buckets - 1, d3.max(mapped, function (d) { return d.sumval; })])
                .range(greens);      
    rect.exit().remove();
       
    rect = rect.enter().append("g");
    
    rect.append("rect")
        .attr("class", "day")
        .attr("width", cellSize)
        .attr("height", cellSize)
        .attr("x", function(d) {
          return 30 + day(d.date) * cellSize + 20; 
        })
        .attr("y", function(d) { 
          var week_diff = week(d.date) - week(new Date(year(d.date), month(d.date)-1, 1) );
          return (week_diff*cellSize);// + cellSize*8 - cellSize/2;
        });
    rect.append("text") 
        .attr("x", function(d) {
          return 30 + day(d.date) * cellSize + 20; 
        })
        .attr("y", function(d) { 
          var week_diff = week(d.date) - week(new Date(year(d.date), month(d.date)-1, 1) );
          return 15+ (week_diff*cellSize);// + cellSize*8 - cellSize/2;
        })
        .text(function(d){return dayofmonth(d.date);});
        
    rect.filter(function(d) {return d.sumval > 0; })
        .select("rect").style("fill",function(d){return colorScale(d.sumval);})
        .select("title")
            .text(function(d) { return d + ": "; });

    rect.filter(function(d) {return d.sumval > 0; }).on("mouseover", mouseover);
    rect.filter(function(d) {return d.sumval > 0; }).on("mouseout", mouseout);
    function mouseover(d) {
        div.transition()        
            .duration(200)      
            .style("opacity", .9); 
        div.html(function(){
        //This could probably be greatly reduced in size by a hashmap or something similar
        var myhtml = "";
        var create = 0,comment = 0,rcomment = 0,talk = 0,rtalk = 0,give = 0,rgive = 0;
        for(var i in d.stats){
            switch(d.stats[i][0]){
                case "create":create++;break;
                case "comment":comment++;break;
                case "rcomment":rcomment++;break;
                case "talk":talk++;break;
                case "rtalk":rtalk++;break;
                case "give":give++;break;
                case "rgive":rgive++;break;
            }
        };
        if(create > 0)
            myhtml += "Stories created: " + create + "<br/>";
        if(comment > 0)
            myhtml += "Comments left: " + comment + "<br/>";
        if(rcomment > 0)
            myhtml += "Comments received: " + rcomment + "<br/>";
        if(give > 0)
            myhtml += "Donations made: " + give + "<br/>";
        if(rgive > 0)
            myhtml += "Donations received: " + rgive + "<br/>";
        if(talk > 0)
            myhtml += "Chats started by you: " + talk + "<br/>";
        if(rtalk > 0)
            myhtml += "Chats started by others: " + rtalk + "<br/>";            
        return myhtml;
        })  
        .style("left", (d3.event.pageX) + "px")     
        .style("top", (d3.event.pageY - 28) + "px")
        .style("background", "lightgreen");    
      }
      
      function mouseout (d) {
        div.transition()        
            .duration(500)      
            .style("opacity", 0);   
      }
    }
    */
</script>
