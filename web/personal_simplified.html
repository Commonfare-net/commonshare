<!DOCTYPE html>
<meta charset="utf-8">
<head>
<link rel="stylesheet" type="text/css" href="css/commonfare.css">
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
<link href="https://fonts.googleapis.com/css?family=Dosis:800" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
<div style="width: 100%; text-align:center;">
        <h5>Your Commonshare</h5>    
    <div style="text-align:center;display:inline-block;width:auto;margin:0px 30px 5px 30px;">
        <div class="bigchart border" style="position:relative;border-radius: 50%;">
            <svg id="minilabels" width="210" height="210" style="position:absolute;top:-5px;right:-5px" ></svg>
            <svg id="minigraph"  width="200" height="200"></svg>
            <div id="minidescription" style="display: flex;justify-content: center; align-items: center;text-align: center;position:absolute;width:100%;margin: auto auto; height: 75%; top:0;left: 0;pointer-events:none;font-family:'Dosis';font-size:16px">
            </div>
        </div>
        <div class="datepicker" style="line-height:100%">
            <i class="fa fa-arrow-left arrow" onclick="updateMiniGraph(-1)"></i>
            <b id="minigraphdate" style="font-size:24px;font-family:Dosis"></b>
            <i class="fa fa-arrow-right arrow" onclick="updateMiniGraph(1)"></i>
        </div>
    </div>
    <div style="text-align:center;display:inline-block;width:auto;position:relative;margin:0px 30px 5px 30px;">
        <div class="bigchart border"  style="display:table;border-style: solid; border-color: #E7472E; border-width: 3px; border-radius: 50%; overflow: hidden">
            <svg id="cookie" width="200" height="200"></svg>
            <div id="cookiedescription" style="display: flex;justify-content: center; align-items: center;text-align: center;position:absolute;width:100%;margin: auto auto; height: 75%; top:0;left: 0;pointer-events:none;font-family:'Dosis';font-size:16px">        
            </div>
        </div> 
        <div class="datepicker" style="line-height:100%">
            <i class="fa fa-arrow-left arrow" onclick="updateCookie(-1)"></i>
            <b id="cookiedate" style="font-size:24px;font-family:Dosis"></b>
            <i class="fa fa-arrow-right arrow" onclick="updateCookie(1)"></i>
        </div>
    </div>
    <div style="text-align:center;display:inline-block;width:auto;position:relative;margin:0px 30px 5px 30px;">
        <div class="bigchart border" id="bunchdiv" style="position:relative;border-radius: 50%;overflow: visible">
            <svg id="bunchlabels" width="210" height="210" style="position:absolute;top:-5px;right:-5px" ></svg>
            <svg id="bunches" width="200" height="200"  ></svg>
            <div id="bunchesdescription" style="display: flex;justify-content: center; align-items: center;text-align: center;position:absolute;width:100%;margin: auto auto; height: 75%; top:0;left: 0;pointer-events:none;font-family:'Dosis';font-size:16px">
            </div>
        </div>  
        <div class="datepicker" style="line-height:100%">
            <i class="fa fa-arrow-left arrow" onclick="updateBunches(-1)"></i>
            <b id="bunchesdate" style="font-size:24px;font-family:Dosis"></b>
            <i class="fa fa-arrow-right arrow" onclick="updateBunches(1)"></i>
        </div>
    </div>
    <div style="text-align:center;display:inline-block;width:auto;position:relative;margin:0px 30px 5px 30px;">
        <div class="bigchart border" style="display:table">
            <svg id="donut" width="240" height="240"></svg>
            <div id="donutdescription" style="display: flex;justify-content: center; align-items: center;text-align: center;position:absolute;width:100%;margin: auto auto; height: 75%; top:0;left: 0;pointer-events:none;font-family:'Dosis';font-size:16px">
            </div>
        </div>    
        <div class="datepicker" style="line-height:100%">
            <i class="arrow fa fa-arrow-left" onclick="updateDonut(-1)"></i>
            <b id="donutdate" style="font-size:24px;font-family:Dosis"></b>
            <i class="arrow fa fa-arrow-right" onclick="updateDonut(1)"></i>
        </div>   
    </div>
</div>

</body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="scripts/minigraph.js"></script>

<script>
//These forces are tweaked to attract connected nodes to the center

function updateDonut(value){
    if(value == -1)
        if(currentdonut == maxindex-1)return; 
        else currentdonut++;
    else
        if(currentdonut == 0)return;
        else currentdonut --;
    plotdonut(graph_data[currentdonut],node_data[currentdonut]);
    $('#donutdate').text(getDateText(node_data[currentdonut]));
}
function updateCookie(value){
    if(value == -1)
        if(currentcookie == maxindex-1)return;
        else currentcookie++;
    else
        if(currentcookie == 0)return;
        else currentcookie --;
    plotcookie(graph_data[currentcookie],node_data[currentcookie]);
    $('#cookiedate').text(getDateText(node_data[currentcookie]));
    
}
function updateBunches(value){
    if(value == -1)
        if(currentbunches == maxindex-1)return;
        else currentbunches++;
    else
        if(currentbunches == 0)return;
        else currentbunches --;
    plotbunches(graph_data[currentbunches]);
    $('#bunchesdate').text(getDateText(node_data[currentbunches]));
    
}
function updateMiniGraph(value){
    if(value == -1)
        if(currentmini == maxindex-1)return;
        else currentmini++;
    else
        if(currentmini == 0)return;
        else currentmini--;
    plotminigraph(graph_data[currentmini]);
    $('#minigraphdate').text(getDateText(node_data[currentmini]));
    
}

var keytypes = {
    "story": ['create_story','comment_story'],
    "listing": ['create_listing','comment_listing'],
    "transaction": ['transaction'],
    "social": ['conversation']
};
var mykeys = ['social','story','transaction','listing'];
var range = ['#a6cee3', '#1f78b4', '#b2df8a', '#33a02c'];

var brightrange = [d3.rgb('#a6cee3').brighter(0.3),d3.rgb('#1f78b4').brighter(0.3),d3.rgb('#b2df8a').brighter(0.3),d3.rgb('#33a02c').brighter(0.3)];
var nodetypes = ['commoner','story','listing'];
var noderange = ['#33a02c','#1f78b4','purple'];

nodecolor = d3.scaleOrdinal()
.domain(nodetypes)
.range(noderange);
color = d3.scaleOrdinal() // D3 Version 4
		.domain(mykeys)
		.range(range);
brightercolor = d3.scaleOrdinal()
        .domain(mykeys)
        .range(brightrange);
var parseTime = d3.timeParse("%Y/%m/%d");
var tooltipFormat = d3.timeFormat("%b %d");
var urlParams = new URLSearchParams(window.location.search);
var userid = urlParams.get('userid'); // "edit"

var data = {};
var node_data = {};
var graph_data = {};
var numticks = 0;

function findNode(node) {
	return node['id'] == userid;
}
var currentmini = 0;
var currentcookie = 0;
var currentbunches = 0;
var currentdonut = 0;
var maxindex = 0;
d3.json('data/userdata/usersmonthly/' + userid + '.json', function (results) {
	data = results;
   // latestdate = parseTime(data[0]['nodes'][0]['date']);
	for (var fortnight in results) {
		node_data[fortnight] = results[fortnight]['nodes'].find(findNode);
		node_data[fortnight].date = parseTime(node_data[fortnight].date);
		graph_data[fortnight] = results[fortnight];
        //This is necessary for D3 to map source and target indices to their respective nodes 
        plotcookie(graph_data[fortnight],node_data[fortnight]);
        plotdonut(graph_data[fortnight],node_data[fortnight]);
        plotminigraph(graph_data[fortnight]);
        plotbunches(graph_data[fortnight]);
        maxindex++;
	}
	numticks = results.length;
	plotminigraph(graph_data[0]);
	plotcookie(graph_data[0],node_data[0]);
	plotbunches(graph_data[0]);
	plotdonut(graph_data[0],node_data[0]);

    $('#donutdate').text(getDateText(node_data[currentdonut]));
    $('#minigraphdate').text(getDateText(node_data[currentmini]));
    $('#cookiedate').text(getDateText(node_data[currentcookie]));
    $('#bunchesdate').text(getDateText(node_data[currentbunches]));

    
});

function getDateText(data){
    return tooltipFormat(data.date) + "-" + tooltipFormat(d3.timeWeek.offset(data.date,2))
}

function getUrl(type, name){
    var prefix;
    if(type == 'commoner' || type == 'transaction' || type == 'social')
        prefix = "https://commonfare.net/en/commoners/";
    if(type == 'listing')
        prefix = "https://commonfare.net/en/listings/";
    if(type == 'story')
        prefix = "https://commonfare.net/en/stories/";
    
    name = name.normalize('NFD').replace(/[\u0300-\u036f]/g, "");
            name = name.replace(/[^a-z0-9/s _-]/gi, '').toLowerCase();

        name = name.split(' ');
        var result = '';
        for (var i = 0; i < name.length; i++) {
            if ((name.length - 1) == i) {
                result += name[i];
            } else {
                result += name[i] + '-';
            }
        }
        result = result.replace('---','-');
        var storyurl = prefix + result;
        return storyurl;
}
</script>
<script src="scripts/cookie.js"></script>
<script src="scripts/bunches.js"></script>
<script src="scripts/donut.js"></script>
