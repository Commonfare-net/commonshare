<!DOCTYPE html>
<meta charset="utf-8">
<head>
<link rel="stylesheet" type="text/css" href="../css/buttons.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="../css/commonfare.css"></head>
        
<body>
<br>
   <svg style="width:70%; float:left; display:inline;" class="bigvis" width="800" height="800"></svg>
   <div id="loadingDiv" style="display:inline">
        <img src="icons/ajax-loader.gif" height="100" width="100"/>
   </div>
</body>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="../js/recommenderfuncs.js"></script>

<script>
var urlParams = new URLSearchParams(window.location.search);
//All this stuff is for the network viz
var graph = {};
    var userid = 0;
    var storyid = 0;
function loadDataFiles() {
	var url = "../data/output/graphdata/biweekly/0.json";
	$.ajax({

		url: url,
		type: "HEAD",
		error: function () {},
		success: function () {
			d3.json(url, function (results) {
                graph = results;
            	draw(0, "all");    
                
            });
		}
	});
}

loadDataFiles();

//Loading GIF
var $loading = $('#loadingDiv').hide();
$(document)
  .ajaxStart(function () {
    $loading.show();
  })
  .ajaxStop(function () {
    $loading.hide();
  });
  
function draw(tag, filtertype) {
	nodetypes = {};
    nodenames = {};
	//https://stackoverflow.com/questions/11347779/jquery-exclude-children-from-text
	$.fn.ignore = function (sel) {
		return this.clone().find(sel || ">*").remove().end();
	};

	selected_node = "";
	node = node.data(graph.nodes, function (d) {
			return d.id;
		});
	link = link.data(graph.links, function (d) {
			return d.source + "-" + d.target;
		});
	tagcounts = graph.tagcount;

	node.exit().transition()
	.attr("r", 0)
	.remove();


    var php_data = "";
	node = node.enter().append("circle")
		.call(d3.drag()
			.on("start", dragstarted)
			.on("drag", dragged)
			.on("end", dragended))
		.merge(node)
        .attr("class","circlenode")
		.each(function (d) {
			nodetypes[d.id] = d.type;
            nodenames[d.id] = (d.type == "story") ? d.title : d.name;
        })

		.attr("id", function (d) {
			return "n" + d.id;
		}) //Now each datum can be accessed as a DOM element
		.attr("meta", function (d) {
			return "n" + JSON.stringify(d.type);
		})
		.attr("r", function (d) {
			return (d.kcore * 2) + 5;
		})
		.attr("fill", function (d) {         
			if (d.type == "commoner")
				return d3.color("steelblue");
			if (d.type == "listing")
				return d3.color("purple");
			if (d.type == "tag")
				return d3.color("lightgreen");

			return d3.color("red");
		}) //Coloured based on their type
		.style("opacity",0.15)
		.on("click", function (od) {
            if(od.type == 'commoner')
                userid = od.id;
            else if(od.type == 'story')
                storyid = od.id;
            else
                return;
          node.style("opacity", function (d) { //Make nodes and links transparent if they arent linked to tags
                                    if(d.id == userid || d.id == storyid)
                                    return 1;
                                    return 0.15;
                                });
            if(storyid == 0 || userid == 0)
                return;
                
                $.ajax({
                   url: "pagerank.php",
                   type: "GET",
                   data: {userid: userid, storyid: storyid},
                   success: function(data){
                        php_data = data;
                        pagerank_vals = {};
                                    var pageranks = php_data.replace("[","").replace("]","").replace(/\s/g,"").replace(/\'/g,"").split(",");
                                    for(var x in pageranks){
                                        var id_and_rank = pageranks[x].split(":");
                                        pagerank_vals[id_and_rank[0]] = id_and_rank[1];
                                    }
                        node.attr("fill", function (d) {
                                    if(d.id in pagerank_vals && pagerank_vals[d.id] == 'neglected')
                                        return d3.color("blue");
                                    if (d.id == storyid)
                                        return d3.color("orange");           
                                    if (d.type == "commoner")
                                        return d3.color("steelblue");
                                    if (d.type == "listing")
                                        return d3.color("purple");
                                    if (d.type == "tag")
                                        return d3.color("lightgreen");

                                    return d3.color("red");
                                }) //Coloured based on their type
                                .style("opacity", function (d) { //Make nodes and links transparent if they arent linked to tags
                                    if(d.id == userid || d.id == storyid || d.id in pagerank_vals)
                                    return 1;
                                    return 0.15;
                                });
                     
                   }
                });
		})
        		.on("mouseover", function (d) {
			selected_node = d.id;
			d3.select(this).attr("fill", d3.color("orange"));
			sourcelinks = link.filter(function (d) {
					return d.source.id == selected_node || d.target.id == selected_node;
				});

			sourcelinks.each(function (d) {
				d3.select(this).attr("oldstrokeval", d3.select(this).style("stroke-width"));
				d3.select(this).attr("oldcolourval", d3.select(this).style("stroke"));
				d3.select(this).style("stroke", "green");

			});
			//Add the tooltips, formatted based on whether they represent a user or story
			div.transition()
			.duration(200)
			.style("opacity", .9);
			if (d.type == "commoner" || d.type == "tag") {
				div.html(d.name)
				.style("left", (d3.event.pageX) + "px")
				.style("top", (d3.event.pageY - 28) + "px")
				.style("background", function () {
					if (d.type == "commoner")
						return "lightsteelblue";
					return "lightgreen";
				});
			} else {
				div.html(d.title)
				.style("left", (d3.event.pageX) + "px")
				.style("top", (d3.event.pageY - 28) + "px")
				.style("background", "pink");
			}
		})
		.on("mouseout", function (d) {
			//Set the colour of links back to black, and the thickness to its original value
			d3.select(this).attr("fill", function (d) {
				if (d.type == "commoner")
					return d3.color("steelblue");
				if (d.type == "listing")
					return d3.color("purple");
				if (d.type == "tag")
					return d3.color("lightgreen");
				return d3.color("red");
			});
			sourcelinks.each(function (d) {
				d3.select(this).style("stroke", d3.select(this).attr("oldcolourval"));
			});
			sourcelinks.each(function (d) {
				d3.select(this).style("stroke-width", d3.select(this).attr("oldstrokeval"));
			});
			div.transition()
			.duration(500)
			.style("opacity", 0);
		});
		//Node and link highlighting
		//.on("mouseover", mouseovernode)
		//.on("mouseout", mouseoutnode);
    ;

        addLinks();
      //  renderList();
        d3.timeout(function () {
		// Update and restart the simulation.
		simulation.nodes(graph.nodes);

		//Manually update the simulation so it doesnt take a long time to do its thing
		simulation.force("link").links(graph.links);
			simulation.alpha(1);
			for (var i = 0, n = Math.ceil(Math.log(simulation.alphaMin()) / Math.log(1 - simulation.alphaDecay())); i < n; ++i) {
				simulation.tick();
			}
		
		link
		.attr("x1", function (d) {
			return d.source.x;
		})
		.attr("y1", function (d) {
			return d.source.y;
		})
		.attr("x2", function (d) {
			return d.target.x;
		})
		.attr("y2", function (d) {
			return d.target.y;
		});

		node
		.attr("cx", function (d) {
			return d.x;
		})
		.attr("cy", function (d) {
			return d.y;
		});
		//If weve clicked on a node, maintain its focus while going through the different months
		if (clicked_node != "")
			svg.call(zoom.transform, transform);
	});
        
}

</script>

